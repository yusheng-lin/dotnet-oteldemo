# Apache Kafka with KRaft mode (no ZooKeeper required)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: kafka
  namespace: {{ .Release.Namespace }}
spec:
  serviceName: kafka
  replicas: {{ .Values.kafka.replicas }}
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app: kafka
  template:
    metadata:
      labels:
        app: kafka
    spec:
      enableServiceLinks: false
      containers:
      - name: kafka
        image: "{{ .Values.images.kafka.repository }}:{{ .Values.images.kafka.tag }}"
        command:
        - sh
        - -c
        - |
          # Extract ordinal index from hostname (e.g., kafka-0 -> 0)
          NODE_ID=$(hostname | awk -F'-' '{print $NF}')
          export KAFKA_NODE_ID=$((NODE_ID + 1))
          export KAFKA_ADVERTISED_LISTENERS="PLAINTEXT://kafka-${NODE_ID}.kafka.{{ .Release.Namespace }}.svc.cluster.local:9092"

          echo "Current content of /var/lib/kafka/data:"
          ls -R -la /var/lib/kafka/data

          # Format storage if not already formatted
          if [ ! -f /var/lib/kafka/data/meta.properties ]; then
            echo "meta.properties not found. Cleaning and Formatting with node.id=${KAFKA_NODE_ID}..."
            # Clean directory to remove lost+found or other debris
            rm -rf /var/lib/kafka/data/* || echo "Warning: Failed to clean data directory"
            
            cp /opt/kafka/config/kraft/server.properties /tmp/server.properties
            echo "log.dirs=/var/lib/kafka/data" >> /tmp/server.properties
            echo "node.id=${KAFKA_NODE_ID}" >> /tmp/server.properties
            echo "controller.quorum.voters=1@kafka-0.kafka.{{ .Release.Namespace }}.svc.cluster.local:9093,2@kafka-1.kafka.{{ .Release.Namespace }}.svc.cluster.local:9093,3@kafka-2.kafka.{{ .Release.Namespace }}.svc.cluster.local:9093" >> /tmp/server.properties
            /opt/kafka/bin/kafka-storage.sh format -t {{ .Values.kafka.clusterId }} -c /tmp/server.properties || { echo "Storage format failed!"; exit 1; }
          fi

          /opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/kraft/server.properties \
          --override process.roles=broker,controller \
          --override node.id=${KAFKA_NODE_ID} \
          --override log.dirs=/var/lib/kafka/data \
          --override listeners=PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093 \
          --override advertised.listeners=${KAFKA_ADVERTISED_LISTENERS} \
          --override controller.quorum.voters=1@kafka-0.kafka.{{ .Release.Namespace }}.svc.cluster.local:9093,2@kafka-1.kafka.{{ .Release.Namespace }}.svc.cluster.local:9093,3@kafka-2.kafka.{{ .Release.Namespace }}.svc.cluster.local:9093 \
          --override listener.security.protocol.map=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT \
          --override controller.listener.names=CONTROLLER \
          --override inter.broker.listener.name=PLAINTEXT \
          --override offsets.topic.replication.factor=3 \
          --override transaction.state.log.replication.factor=3 \
          --override transaction.state.log.min.isr=2 \
          --override cluster.id={{ .Values.kafka.clusterId }}
        env:
        - name: CLUSTER_ID
          value: {{ .Values.kafka.clusterId | quote }}
        ports:
        - containerPort: 9092
        - containerPort: 9093
        volumeMounts:
        - name: data
          mountPath: /var/lib/kafka/data
        readinessProbe:
          exec:
            command:
            - /opt/kafka/bin/kafka-broker-api-versions.sh
            - --bootstrap-server
            - localhost:9092
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 10
          failureThreshold: 5
        livenessProbe:
          exec:
            command:
            - /opt/kafka/bin/kafka-broker-api-versions.sh
            - --bootstrap-server
            - localhost:9092
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: {{ .Values.kafka.storage }}
---
apiVersion: v1
kind: Service
metadata:
  name: kafka
  namespace: {{ .Release.Namespace }}
spec:
  clusterIP: None
  publishNotReadyAddresses: true
  selector:
    app: kafka
  ports:
    - name: client
      port: 9092
      targetPort: 9092
    - name: controller
      port: 9093
      targetPort: 9093
