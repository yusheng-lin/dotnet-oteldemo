# Note: Images are pulled from GitLab Container Registry
# Update GITLAB_REGISTRY below to match your GitLab instance
# Create imagePullSecret: kubectl create secret docker-registry gitlab-registry \
#   --docker-server=gitlab.example.com:5050 \
#   --docker-username=<your-username> \
#   --docker-password=<your-token> \
#   -n otel-demo

apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway
  namespace: otel-demo
spec:
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      imagePullSecrets:
      - name: gitlab-registry
      containers:
      - name: gateway
        image: gitlab.example.com:5050/yusheng/otel-demo/gateway:latest
        imagePullPolicy: Always
        envFrom:
        - configMapRef:
            name: otel-demo-config
        env:
        - name: ORDERSERVICE_ENDPOINT
          value: "http://orderservice.otel-demo.svc.cluster.local:8080/order"
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: gateway
  namespace: otel-demo
spec:
  selector:
    app: gateway
  ports:
    - port: 8080
      targetPort: 8080

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: orderservice
  namespace: otel-demo
spec:
  selector:
    matchLabels:
      app: orderservice
  template:
    metadata:
      labels:
        app: orderservice
    spec:
      imagePullSecrets:
      - name: gitlab-registry
      containers:
      - name: orderservice
        image: gitlab.example.com:5050/yusheng/otel-demo/orderservice:latest
        imagePullPolicy: Always
        envFrom:
        - configMapRef:
            name: otel-demo-config
        env:
        - name: PAYMENTSERVICE_ENDPOINT
          value: "http://paymentservice.otel-demo.svc.cluster.local:8080/pay"
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: orderservice
  namespace: otel-demo
spec:
  selector:
    app: orderservice
  ports:
    - port: 8080
      targetPort: 8080

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: paymentservice
  namespace: otel-demo
spec:
  selector:
    matchLabels:
      app: paymentservice
  template:
    metadata:
      labels:
        app: paymentservice
    spec:
      imagePullSecrets:
      - name: gitlab-registry
      containers:
      - name: paymentservice
        image: gitlab.example.com:5050/yusheng/otel-demo/paymentservice:latest
        imagePullPolicy: Always
        envFrom:
        - configMapRef:
            name: otel-demo-config
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: paymentservice
  namespace: otel-demo
spec:
  selector:
    app: paymentservice
  ports:
    - port: 8080
      targetPort: 8080
